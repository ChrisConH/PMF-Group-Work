---
title: "Homework assignment 1. Programación y modelación financiera (PMF)"
author: 
- name: Lara Weitgasse A01759114
- name: Karina Albarrán A01377604
- name: Christian Contreras A00819400
- name: María Julia Romero A00819400
- name: Melanie Flores A00820434
- name: Adriana Beatriz Santos Monterroza A00823399
date: "9/8/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyquant)
library(ggplot2)
library(quantmod)
library(finreportr)
library(tibble)
library(tbl2xts)
library(dplyr)
library(lazyeval)
library(lubridate)
```

## Asset returns 
As we know, a return is the percentage change of an asset price.It turns out that asset returns exhibit more attractive statistical properties than asset prices themselves.  In finance, it is very important to know the asset returns because our primary goal of investing in a financial market is to make profits without taking excessive risks. 
Now, let's proceed with our analysis. The original FANG database
from 2013-01-02 to 2016-12-30 will be compared with the analyzed results from 2016-12-30 to 2021-07-31. 

## From prices tu returns FANG database
First, we need a visual representation of the FANG database. In this part we have daily stock prices per stock. 

```{r, echo=FALSE, warning=FALSE}
#Plot the data FANG data
FANG_daily_all <- FANG %>%
  group_by(symbol) %>%
  ggplot(aes(x= date, y= adjusted, color = symbol)) +
  geom_line(size = 1) +
  labs(title = "Daily stock prices from 2013-01-02 to 2016-12-30 ",
       x = "", y ="adjusted princes", color = "") +
  scale_y_continuous(labels = scales::dollar) +
  theme_tq() + scale_color_tq()
FANG_daily_all
```
We can see how stock prices fluctuate in different ranges. Here we still cannot make a decision about the action to prefer since we only can observe the fluctuation of the stock prices. Remember making investment decisions based on prices could be misleading. Besides, we must separate each graph so that we can see more clearly each price evolution. 

```{r, echo=FALSE, warning=FALSE}
#Facet makes it easier to read
FANG_daily <- FANG %>%
  group_by(symbol) %>%
  ggplot(aes(x= date, y= adjusted, color = symbol)) +
  geom_line(size = 1) +
  labs(title = "Daily stock prices -from 2013-01-02 to 2016-12-30 ",
       x = "", y ="adjusted princes", color = "") +
        facet_wrap( ~ symbol, ncol = 2, scales = "free_y") +
  scale_y_continuous(labels = scales::dollar) +
  theme_tq() + scale_color_tq()
FANG_daily
```
Now that it is more clear we can notice that all stock prices have a positive trend over time, but 2014 was a little bad for Amazon, Google and Netflix. Let's compare our plot with the daily stock prices from 2016-12-30 to 2021-07-31.

## From prices to returns from 2016-12-30 to 2021-07-31 
At first we loaded and plotted the data for the four companies Amazon, Facebook, Google and Netflix for the timeframe 2016-12-30 to 2021-07-31 in order to compare them to the FANG dataset that ends in 2016.

```{r, echo=FALSE, warning=FALSE}
#Plot: Amazon, Facebook, Google and Netflix 2016-12-30 to 2021-07-31
Stock_AFGN <- tq_get(c("AMZN","FB","GOOG","NFLX"))%>%
     group_by(symbol) %>%
     ggplot(aes(x = date, y = adjusted, color = symbol)) +
     geom_line(size = 1) +
     coord_x_date(xlim = c("2016-12-30","2021-07-31"))+
     labs(title = "Daily stock prices - 2016-12-30 to 2021-07-31",
          x = "", y = "Adjusted prices", color = "") +
     scale_y_continuous(labels = scales::dollar) +
     theme_tq() + scale_color_tq()
Stock_AFGN
```
As this plot distorts the perspective on the stock market of the four companies, the next plot shows the four companies separated in order to make comparisons easier and valuable.

```{r, echo=FALSE, warning=FALSE}
#Amazon, Facebook, Google and Netflix 2016-12-30 to 2021-07-31
Stock_AFGN <- tq_get(c("AMZN","FB","GOOG","NFLX"))%>%
     group_by(symbol) %>%
     ggplot(aes(x = date, y = adjusted, color = symbol)) +
     geom_line(size = 1) +
     coord_x_date(xlim = c("2016-12-30","2021-07-31"))+
     labs(title = "Daily stock prices - 2016-12-30 to 2021-07-31",
          x = "", y = "Adjusted prices", color = "") +
        facet_wrap(~ symbol, ncol = 2, scales = "free_y") +
     scale_y_continuous(labels = scales::dollar) +
     theme_tq() + scale_color_tq()
Stock_AFGN
```
The above plot has the strength of showing the companies separated, however, to make a good comparison, it is important to look at annual returns which will be shown later. It is also important to emphasize, that in a period of 2020 there was a decline in the stock prices of Amazon, Google, Facebook and Netflix. This is because the stock price decreases by the announcement of the pandemic, approximately in March, which is when we can see the decrease in prices. Notwithstanding the pandemic, the four companies recovered. 

## Comparison from prices to returns 
We can notice that from 2013-01-02 to 2016-12-30 compare to new data from 2016-12-30 to 2021-07-31, the prices of all four companies has grown significantly. In both cases, we could say that we prefer Amazon or Google because they have larger price changes compared with Facebook or Netflix, but this would be a mistake. On the other hand, Google in the new data from 2016-12-30 to 2021-07-31 compare to the FANG database had sustained growth, in other words we can say that it had growth without much volatility as Netflix.  
As mentioned above, we can't make a decision based solely on price, but we can visualize the data to help us to compare the evolution of price per stock. 

## Yearly Returns
To make a good and inform decision we need the asset returns. So, we select the adjusted prices and transform it into yearly returns. First we are going to analyze FANG database.
```{r,echo=FALSE, warning=FALSE}
#Yearly returns FANG database
FANG_annual_returns <- FANG %>%
        group_by(symbol)%>%
        tq_transmute(select = adjusted,
                     mutate_fun = periodReturn,
                     period = "yearly", 
                     type = "arithmetic")
FANG_annual_returns
```
Now, the next chunk code shows how to visualize the annual returns in a plot
``` {r,echo=FALSE, warning=FALSE}
#Plot tha annual returns FANG database
FANG_annual_returns %>%
        ggplot(aes(x= date-365, y = yearly.returns, fill = symbol)) +
        geom_col() +
        geom_hline(yintercept = 0, color = palette_light()[[1]]) +
        scale_y_continuous(labels = scales::percent) +
        labs(title = "FANG: Annual Returns",
             y = "Annual Returns", x = "") +
        facet_wrap(~ symbol, ncol = 2, scales = "free_y") + 
        theme_tq() + scale_fill_tq()
```
2014 was indeed the worst year for Amazon, Google and Netflix. Now, lets see the annual returns from 2016-12-30 to 2021-07-31. 

```{r,echo=FALSE, warning=FALSE}
#Annual returns of Amazon, Facebook, Google and Netflix from 2017 to 2021
Stock_AFGN_annual_returns <- tq_get(c("AMZN","FB","GOOG","NFLX"))%>%
     group_by(symbol) %>%
        filter(date >= as.Date("2016-12-30") & date <= as.Date("2021-07-31"))%>%
        tq_transmute(select = adjusted,
        mutate_fun = periodReturn,
        period = "yearly",
        type = "arithmetic")

Stock_AFGN_annual_returns
```
Now, the next chunk code shows how to visualize the annual returns from 2017 to 2021 in a plot
```{r,echo=FALSE, warning=FALSE}
Stock_AFGN_annual_returns %>%
ggplot(aes(x = date-365, y = yearly.returns, fill = symbol)) +
geom_col() +
geom_hline(yintercept = 0, color = palette_light()[[1]]) +
scale_y_continuous(labels = scales::percent) +
labs(title = "Annual Returns: AMZN, FB, GOOG and NFLX from 2017 to 2021",
y = "Annual Returns", x = "") +
facet_wrap(~ symbol, ncol = 2, scales = "free_y") +
theme_tq() + scale_fill_tq()
```
Here it is easy to see that 2018 was a bad year to Google and Facebook. The year 2020 was good for Amazon and Netflix, and we could be argued to the fact that during the pandemic online shopping and movie platforms increased their sales. 

## Comparative of Annual Returns 
We can see that AMZN in the FANG database... 

## Cumulative Returns 
The cumulative returns is the total change in the investment price over a set time. Taking this concept into account we will start by analyzing FANG database.
```{r,echo=FALSE, warning=FALSE}
#Cumulative Returns FANG database
FANG_annual_cum_returns <- FANG_annual_returns %>%
        mutate(cr = 100*cumprod(1 + yearly.returns)) %>%
#Plot the results
ggplot(aes(x = date-365, y = cr, fill = symbol)) + geom_col() +
labs(title = "Yearly cumulative USD returns.",
subtitle = "100 USD investment growth from 2013-01-01 to 2016-12-31",
x = "", y = "USD value at the end of the year", color = "") +
scale_y_continuous(labels = scales::dollar) +
facet_wrap(~ symbol, ncol = 2, scales = "free_y") +
theme_tq() + scale_color_tq()
FANG_annual_cum_returns
```

```{r,echo=FALSE, warning=FALSE}
#Cumulative Returns 2017-2021
Stock_AFGN_annual_cum_returns <- Stock_AFGN_annual_returns %>%
mutate(cr = 100*cumprod(1 + yearly.returns)) %>%
# Plot the results.
ggplot(aes(x = date-365, y = cr, fill = symbol)) + geom_col() +
labs(title = "Yearly cumulative USD returns.",
subtitle = "100 USD investment growth from 2016-12-30 to 2021-07-31",
x = "", y = "USD value at the end of the year", color = "") +
scale_y_continuous(labels = scales::dollar) +
facet_wrap(~ symbol, ncol = 2, scales = "free_y") +
theme_tq() + scale_color_tq()
Stock_AFGN_annual_cum_returns
```
## Comparative Yearly Cumulative returns
The yearly cumulative return of Netflix has decreased compared to the FANG database from 2013 to 2016. 

## Monthly Returns
Now we modify the code abode to show monthly returns instead of yearly 
```{r,echo=FALSE, warning=FALSE}
#Monthly returns FANG database
FANG_monthly_returns <- FANG %>%
        group_by(symbol)%>%
        tq_transmute(select = adjusted,
                     mutate_fun = periodReturn,
                     period = "monthly", 
                     type = "arithmetic")
FANG_monthly_returns
#Plot the results 
FANG_monthly_returns %>%
        ggplot(aes(x= date-12,
                   y = monthly.returns, fill = symbol)) +
        geom_col() +
        geom_hline(yintercept = 0, color = palette_light()[[1]]) +
        scale_y_continuous(labels = scales::percent) +
        labs(title = "FANG: Monthly Returns",
             y = "Monthly Returns", x = "") +
        facet_wrap(~ symbol, ncol = 2, scales = "free_y") + 
        theme_tq() + scale_fill_tq()
```
We can notice that Google is the most volatile. The plot above reveals how volatile the stocks returns are. Let's compare with the returns from 2017 to 2021.

```{r,echo=FALSE, warning=FALSE}
# Monthly returns 2017-2021
Stock_AFGN_monthly_returns <- tq_get(c("AMZN","FB","GOOG","NFLX"))%>%
     group_by(symbol) %>%
        filter(date >= as.Date("2016-12-30") & date <= as.Date("2021-07-31"))%>%
        tq_transmute(select = adjusted,
        mutate_fun = periodReturn,
        period = "monthly",
        type = "arithmetic")
Stock_AFGN_monthly_returns
# Plot the results.
ggplot(Stock_AFGN_monthly_returns, aes(x = date-12,
        y = monthly.returns, fill = symbol)) +
geom_col() +
geom_hline(yintercept = 0, color = palette_light()[[1]]) +
scale_y_continuous(labels = scales::percent) +
labs(title = "Amazon, Facebook, Google and Netflix: Monthly Returns", y = "Monthly Returns", x = "") +
facet_wrap(~ symbol, ncol = 2, scales = "free_y") +
theme_tq() + scale_fill_tq()
```
# Comparison Monthly Returns

# Cumulative Monthly Returns
Now let's see cumulative monthly returns per stock if investing 100 USD at the beginning of the period. First, let's look at the four companies between 2013 and 2016 from the FANG database. 
```{r,echo=FALSE, warning=FALSE}
#Calculate monthly cumulative returns FANG database
FANG_monthly_cum_returns<- FANG_monthly_returns %>%
        mutate(cr = 100*cumprod(1+ monthly.returns))
#Plot the results
ggplot(FANG_monthly_cum_returns, aes(x = date-12, y = cr,
color = symbol)) +
geom_line(size = 1) +
labs(title = "Monthly cumulative USD returns.",
subtitle = "100 USD investment growth from 2013-01-01 to 2016-12-31",
x = "", y = "USD value at the end of the year",
color = "") +
scale_y_continuous(labels = scales::dollar) +
theme_tq() + scale_color_tq()
```
The above graph would make you presume that Netflix is the best investment in terms of returns, however, to facilitate the reading of the plot it is better to look at every company seperately, therefore, a splitting of the plot in four panels is necessary.
```{r,echo=FALSE, warning=FALSE}
#Plot the results 
ggplot(FANG_monthly_cum_returns, aes(x = date-12, y = cr,
color = symbol)) +
geom_line(size = 1) +
labs(title = "Monthly cumulative USD returns.",
subtitle = "100 USD investment growth from 2013-01-01 to 2016-12-31",
x = "", y = "USD value at the end of the year",
color = "") +
scale_y_continuous(labels = scales::dollar) +
facet_wrap(~ symbol, ncol = 2, scales = "free_y") +
theme_tq() + scale_color_tq()
```
As can be seen in the above figures, Facebook has been the most stable in the four years of investigation, however shows a downwards trend in the past months. The stock has increased from 100 USD to 410 USD, while Amazon, the stock that also shows a downward trend in the past months, rose to 291 USD. Netflix gives the highest returns of 942 USD between 2013 and 2016, however, also shows high volatility. Similarly, Google shows volatility but does not give as high of returns as the other three companies, with only 214 USD. As a result, the most stable investment would have been Facebook, but the highest return stemmed from Netflix. 

In order to facilitate the comparison of the results to the four and a half years later, plotting of the period 2016-12-30 to 2021-07-31 is imperative. 
```{r,echo=FALSE, warning=FALSE}
# Calculate monthly cumulative returns 2016-12-30 to 2021-07-31
Stock_AFGN_monthly_cum_returns <- Stock_AFGN_monthly_returns %>%
mutate(cr = 100 * cumprod(1 + monthly.returns))
# Plot results.
ggplot(Stock_AFGN_monthly_cum_returns, aes(x = date-12, y = cr,
color = symbol)) +
geom_line(size = 1) +
labs(title = "Monthly cumulative USD returns.",
subtitle = "100 USD investment growth from 2016-12-30 to 2021-07-31",
x = "", y = "USD value at the end of the year",
color = "") +
scale_y_continuous(labels = scales::dollar) +
theme_tq() + scale_color_tq()
```
This graph already shows a difference to years 2013 to 2016 with the Netflix stock showing less return and the Amazon having grown in cumulative USD monthly returns. Additionally, Facebook performed worse than the period beforehand, while Google has risen its returns. Once again, splitting the plot in four panels displays a better perspective on the different stocks:
```{r,echo=FALSE, warning=FALSE}
# Plot results.
ggplot(Stock_AFGN_monthly_cum_returns, aes(x = date-12, y = cr,
color = symbol)) +
geom_line(size = 1) +
labs(title = "Monthly cumulative USD returns.",
subtitle = "100 USD investment growth from 2016-12-30 to 2021-07-31",
x = "", y = "USD value at the end of the year",
color = "") +
scale_y_continuous(labels = scales::dollar) +
facet_wrap(~ symbol, ncol = 2, scales = "free_y") +
theme_tq() + scale_color_tq()
```
On July 30, 2021 the four stocks increased the investment of 100 USD on December 30, 2016 to the following monthly cumulative USD returns: Amazon 444 USD, Facebook 310 USD, Google 351 USD and Netflix 418 USD. In this case, the originally 100 USD invested in Amazon or Netflix during the 4 years would lead to the highest returns of 444 USD and 418 USD, respectively. The most stable stock in the investigated time period is Google, while the other three stocks display more volatility. The least return stems from the investment into Facebook as can be seen in the above figures. Google gives higher returns of 41 USD compared to Facebook while it is roughly 70 USD below Netflix. Interestingly, the two stocks showing the least returns, Facebook and Google, are the ones that have an upward trend in the last months of investigation, while the stocks with the highest returns in the period, Amazon and Netflix, display a downward trend.  

# Comparison of Monthly Cumulative USD Returns (2013-2016 vs 2017-2021)
When comparing Amazon, Facebook, Google and Netflix in the period 2013-01-02 to 2016-12-30 to the time frame of 2016-12-30 to 2021-07-31 different outcomes can be observed. First of all, Netflix was the forerunner in the first period of investigation, while in the second time frame the stock was in second place behind Amazon. From 2013 to 2016, Netflix's monthly cumulative USD return was at 942 USD, while in the period to 2021, the returns almost halved to 418 USD. The total return in the whole period for the company was therefore 1,360 USD. Secondly, Amazon, the best performing stock in the period 2017 to 2021 with a cumulative monthly return of 444 USD, was third compared to the other FANG stocks between 2013 and 2016 with a cumulative return of 291 USD on the 100 USD investment. As a result, their total cumulative monthly return was 735 USD. Thirdly, Facebook's stock achieved a comparatively high return of 410 USD in the first period, while the returns dropped by 24% to 310 USD in the following time frame. The total return between 2013 and 2021 is therefore 720 USD. Finally, Google, the company that showed the lowest returns of 214 USD up to 2016, increased the returns to 351 USD with an initial investment of 100 USD in the next four years. The company's total returns for the two periods therefore sum up to 565 USD. As a result, the highest total monthly cumulative returns over the whole period 2013 to 2021 had Netflix with 1,360 USD, followed by Amazon with 735 USD, Facebook with 720 USD and Google with 565 USD.
In terms of volatility, the most stable stock in the first period was Facebook while Google showed the least volatility of the four companies in the last period. Google and Netflix were the stocks that showed an upward trend in the last months of the first period, while Facebook and Google displayed an upward trend in the upcoming months to July 2021.
To sum up, based on the total monthly cumulative returns of the two periods combined, Netflix would be the best investment. A counterargument could be the current downward trend of the stock, however, as could be seen from the investigation, this company has a rather volatile history.


# Distribution of Returns 
Another way to see monthly stock returns is trough density plots. The density plots can show us the distribution of values, which is useful when the objective is to assess the most likely return a stock can have. 
Let's visualize first the density plot for the FANG data. 
````{r,echo=FALSE, warning=FALSE}
#Density plots FANG data
ggplot(FANG_monthly_returns, aes(x = monthly.returns,
                                 fill = symbol)) +
        geom_density(alpha = 0.5) +
        geom_hline(yintercept = 0, color = palette_light()[[1]]) +
        labs(title = "FANG: Charting the Monthly Returns",
             x = "Monthly Returns", y = "Density") + xlim(-0.3, 0.9) +
        theme_tq() + scale_fill_tq()
```
Let's make it clearer 
```{r,echo=FALSE, warning=FALSE}
#Density plots
ggplot(FANG_monthly_returns, aes(x = monthly.returns,
                                 fill = symbol)) +
        geom_density(alpha = 0.5) +
        geom_hline(yintercept = 0, color = palette_light()[[1]]) +
        labs(title = "FANG: Charting the Monthly Returns",
             x = "Monthly Returns", y = "Density") + xlim(-0.3, 0.9) +
        theme_tq() + scale_fill_tq() + facet_wrap(~ symbol, ncol = 2)
```

```{r,echo=FALSE, warning=FALSE}
# Density plots.
ggplot(Stock_AFGN_monthly_returns, aes(x = monthly.returns,
fill = symbol)) +
geom_density(alpha = 0.5) +
geom_hline(yintercept = 0, color = palette_light()[[1]]) +
labs(title = "Amazon, Facebook, Google and Netflix: Charting the Monthly Returns",
x = "Monthly Returns", y = "Density") + xlim(-0.3, 0.9) +
theme_tq() + scale_fill_tq()
```


```{r,echo=FALSE, warning=FALSE}
# Density plots.
ggplot(Stock_AFGN_monthly_returns, aes(x = monthly.returns,
fill = symbol)) +
geom_density(alpha = 0.5) +
geom_hline(yintercept = 0, color = palette_light()[[1]]) +
labs(title = "Amazon, Facebook, Google and Netflix: Charting the Monthly Returns",
x = "Monthly Returns", y = "Density") + xlim(-0.3, 0.9) +
theme_tq() + scale_fill_tq() + facet_wrap(~ symbol, ncol = 2)
```
Let's analyze each plot in comparison with the FANG chart Monthly Returns
AMZN. In the FANG data the most frequent value is around zero. The majority of observations are within -25% and 25%. While in the data from 2016-12-30 to 2021-07-31
GOOG
FB 
NFLX

To complete our previous analysis let's propose some statistical indicators 
```{r,echo=FALSE, warning=FALSE}
# Calculate relevant statistics FANG data
FANG_stats <- FANG_monthly_returns %>%
summarise(mean = mean(monthly.returns), sd = sd(monthly.returns),
sr = mean/sd, iqr = IQR(monthly.returns))
FANG_stats
```
We can see that in this case the stock with highest mean is NFLX and the lowest is GOOG. So, the expected return of NFLX is the highest.  
Let's see the risk of the FANG data in a plot 
```{r,echo=FALSE, warning=FALSE}
#Mean Variance plot 
FANG_stats %>%
        ggplot(aes(x = sd, y = mean, color = symbol)) +
geom_point(size = 5) +
geom_text(aes(label = paste0(round(sr, 3))),
vjust = 2, color = "black", size = 3.5) +
xlim(0.04, 0.18) + ylim(0.01, 0.06) +
labs(title = "The higher the risk, the higher the return",
subtitle = "Numerical values represent return per unit of risk.",
x = "Risk", y = "Return") + theme_tq()
```
Netflix is the stock with the highest return and risk. Now let's compare this results with the data from 2016-12-30 to 2021-07-31
```{r,echo=FALSE, warning=FALSE}
# Calculate relevant statistics from 2016-12-30 to 2021-07-31
Stock_AFGN_stats <- Stock_AFGN_monthly_returns %>%
summarise(mean = mean(monthly.returns), sd = sd(monthly.returns),
sr = mean/sd, iqr = IQR(monthly.returns))
Stock_AFGN_stats
```
In this case, as in the FANG data, the stock with highest mean is NFLX, so the expected return of NFLX is the highest. On the contrary, in this case the lowest mean is FB, so FB expected return is closest to zero. But, the stock with lowest risk is GOOG, because the standard deviation is the lowest.  
Let's see the risk and return in a plot
```{r,echo=FALSE, warning=FALSE}
Stock_AFGN_stats %>%
ggplot(aes(x = sd, y = mean, color = symbol)) +
geom_point(size = 5) +
geom_text(aes(label = paste0(round(sr, 3))),
vjust = 2, color = "black", size = 3.5) +
xlim(0.04, 0.18) + ylim(0.01, 0.06) +
labs(title = "XXXX",
subtitle = "Numerical values represent return per unit of risk.",
x = "Risk", y = "Return") + theme_tq()
```
## Comparison 


```{r,echo=FALSE, warning=FALSE}
# Create random assets.
less_risky <- data.frame(length = rnorm(10000, 0, 1))
more_risky <- data.frame(length = rnorm(10000, 0, 2))
# Name random assets.
less_risky$asset <- 'Less risky asset'
more_risky$asset <- 'Riskier asset'
assets <- rbind(less_risky, more_risky)
# Plot the assets.
ggplot(assets, aes(length, fill = asset)) +
geom_density(alpha = 0.5, adjust = 3)
```

## Conclusion 
